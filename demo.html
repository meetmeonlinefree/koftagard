<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KoftaGard ‚Äî –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –•—É–¥–∂–∞–Ω–¥–∞</title>
  <meta name="description" content="KoftaGard ‚Äî –≥–æ—Ä–æ–¥—Å–∫–æ–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –•—É–¥–∂–∞–Ω–¥–∞: –µ–¥–∞, —Å–∞–ª–æ–Ω—ã, –∞–ø—Ç–µ–∫–∏, —É—Å–ª—É–≥–∏ –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ —Ä—è–¥–æ–º —Å –≤–∞–º–∏." />

  <style>
    :root{
      --bg: #0b0d12;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.52);
      --accent: #7c5cff; /* –±—Ä–µ–Ω–¥–æ–≤—ã–π –∞–∫—Ü–µ–Ω—Ç */
      --accent2: #2dd4bf;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 18px;
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1000px 600px at 20% -10%, rgba(124,92,255,.35), transparent 60%),
                  radial-gradient(900px 500px at 80% 0%, rgba(45,212,191,.18), transparent 55%),
                  radial-gradient(900px 650px at 50% 110%, rgba(124,92,255,.15), transparent 60%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    a{ color: inherit; text-decoration: none; }
    .wrap{ max-width: 1120px; margin: 0 auto; padding: 20px 16px 48px; }

    /* Top bar */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding: 10px 0 18px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight: 750; letter-spacing: .2px;
    }
    .logo{
      width: 36px; height: 36px; border-radius: 12px;
      background: linear-gradient(135deg, rgba(124,92,255,1), rgba(45,212,191,1));
      box-shadow: 0 10px 30px rgba(124,92,255,.25);
    }
    .brand small{ display:block; color: var(--muted2); font-weight: 600; margin-top: 2px; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      border-radius: 14px;
      color: var(--text);
      font-weight: 650;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.18); transform: translateY(-1px); }
    .btn.primary{
      border-color: rgba(124,92,255,.6);
      background: rgba(124,92,255,.18);
    }
    .btn.primary:hover{
      border-color: rgba(124,92,255,.8);
      background: rgba(124,92,255,.24);
    }

    /* Hero */
    .hero{
      border: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border-radius: calc(var(--radius) + 6px);
      padding: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(800px 300px at 30% 0%, rgba(124,92,255,.18), transparent 60%),
                  radial-gradient(700px 260px at 80% 30%, rgba(45,212,191,.14), transparent 60%);
      pointer-events:none;
    }
    .hero-inner{ position:relative; display:grid; grid-template-columns: 1.1fr .9fr; gap:18px; align-items:center; }
    @media (max-width: 880px){
      .hero-inner{ grid-template-columns: 1fr; }
    }
    .hero h1{
      margin:0 0 8px;
      font-size: clamp(24px, 3.2vw, 38px);
      line-height: 1.15;
      letter-spacing: -.4px;
    }
    .hero p{
      margin:0 0 16px;
      color: var(--muted);
      font-size: 15.5px;
      line-height: 1.55;
      max-width: 58ch;
    }

    /* Search panel */
    .searchpanel{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,12,18,.55);
      backdrop-filter: blur(10px);
      border-radius: 18px;
      padding: 14px;
      display:grid;
      gap:10px;
    }
    .fieldrow{
      display:grid;
      grid-template-columns: 1fr 220px 180px;
      gap:10px;
    }
    @media (max-width: 880px){
      .fieldrow{ grid-template-columns: 1fr; }
    }
    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline:none;
      font-size: 15px;
    }
    input::placeholder{ color: rgba(255,255,255,.5); }
    select option{ color: #111; }
    .hint{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      color: var(--muted2);
      font-size: 13px;
      margin-top: 2px;
    }

    /* Sections */
    .section{ margin-top: 22px; }
    .section h2{
      margin: 0 0 10px;
      font-size: 18px;
      letter-spacing: -.2px;
    }
    .sub{
      margin: -6px 0 12px;
      color: var(--muted2);
      font-size: 13.5px;
    }

    /* Category pills */
    .cats{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:10px;
    }
    @media (max-width: 980px){
      .cats{ grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 520px){
      .cats{ grid-template-columns: repeat(2, 1fr); }
    }

    .cat{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 12px 12px;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      min-height: 54px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .cat:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.18); }
    .cat.active{
      border-color: rgba(124,92,255,.7);
      background: rgba(124,92,255,.16);
    }
    .cat .left{ display:flex; align-items:center; gap:10px; }
    .badge{
      width: 34px; height: 34px; border-radius: 12px;
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      border: 1px solid rgba(255,255,255,.10);
    }
    .cat .title{ font-weight: 700; }
    .count{ color: var(--muted2); font-size: 12.5px; }

    /* Cards grid */
    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 580px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: var(--radius);
      overflow:hidden;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    .card:hover{ transform: translateY(-2px); background: rgba(255,255,255,.055); border-color: rgba(255,255,255,.18); }
    .thumb{
      aspect-ratio: 16/9;
      background: rgba(255,255,255,.05);
      position:relative;
    }
    .thumb img{
      width:100%; height:100%; object-fit:cover; display:block;
    }
    .thumb .pill{
      position:absolute; left:12px; top:12px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      background: rgba(0,0,0,.40);
      border: 1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(8px);
    }
    .content{ padding: 12px 12px 14px; }
    .name{
      margin:0 0 6px;
      font-weight: 780;
      font-size: 16px;
      letter-spacing: -.2px;
    }
    .meta{
      margin:0 0 10px;
      color: var(--muted);
      font-size: 13.5px;
      line-height: 1.45;
    }
    .row{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom: 10px;
      color: var(--muted2);
      font-size: 13px;
    }
    .stars{ color: rgba(255,255,255,.82); font-weight: 700; }
    .kpi{ color: var(--muted2); }
    .card .btns{ display:flex; gap:8px; flex-wrap:wrap; }
    .card .btns a{
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-weight: 700;
      font-size: 13px;
    }
    .card .btns a:hover{ border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.06); }
    .empty{
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: var(--radius);
      padding: 16px;
      color: var(--muted);
    }

    footer{
      margin-top: 26px;
      color: var(--muted2);
      font-size: 12.5px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      opacity:.95;
    }
    .mini{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .dot{ width:6px; height:6px; border-radius:50%; background: rgba(45,212,191,.9); box-shadow: 0 0 0 4px rgba(45,212,191,.12); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          KoftaGard
          <small>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –•—É–¥–∂–∞–Ω–¥–∞</small>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnLocate" type="button">üìç –†—è–¥–æ–º —Å–æ –º–Ω–æ–π</button>
        <a class="btn primary" href="#" id="btnAdd">‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ</a>
      </div>
    </div>

    <section class="hero">
      <div class="hero-inner">
        <div>
          <h1>–ù–∞–π–¥–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω—ã, —Å–µ—Ä–≤–∏—Å—ã –∏ –º–µ—Å—Ç–∞ –≤ –•—É–¥–∂–∞–Ω–¥–µ ‚Äî –±—ã—Å—Ç—Ä–æ –∏ —Ç–æ—á–Ω–æ</h1>
          <p>
            KoftaGard –ø–æ–º–æ–≥–∞–µ—Ç –∏—Å–∫–∞—Ç—å –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –∏ –ª–æ–∫–∞—Ü–∏–∏, —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –∏ –Ω–∞—Ö–æ–¥–∏—Ç—å –Ω–æ–≤—ã–µ –º–µ—Å—Ç–∞.
            –î–µ–º–æ-–≤–µ—Ä—Å–∏—è: –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ <b>categories.json</b> –∏ <b>places.json</b>.
          </p>

          <div class="searchpanel">
            <div class="fieldrow">
              <input id="q" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫–æ—Ñ–µ, –∞–ø—Ç–µ–∫–∞, —à–∏–Ω–æ–º–æ–Ω—Ç–∞–∂‚Ä¶" />
              <select id="catSelect">
                <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
              </select>
              <select id="sort">
                <option value="popular">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
                <option value="rating">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Ä–µ–π—Ç–∏–Ω–≥</option>
                <option value="near">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Ä—è–¥–æ–º</option>
              </select>
            </div>
            <div class="hint">
              <span id="status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</span>
              <span id="geoStatus">–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è: –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞</span>
            </div>
          </div>
        </div>

        <div class="searchpanel" style="padding:16px">
          <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px">
            <div>
              <div style="font-weight:800; font-size:15px">–ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ</div>
              <div style="color:var(--muted); font-size:13.5px; line-height:1.55; margin-top:6px">
                1) –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞—Ä—Ç–æ—á–∫–∏ –º–µ—Å—Ç–∞<br>
                2) –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–∞—Ä—Ç—É (Leaflet + OSM)<br>
                3) –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ä–º—É ‚Äú–¥–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ‚Äù (–∑–∞—è–≤–∫–∞)
              </div>
            </div>
            <div class="badge" title="AI" style="border-color: rgba(124,92,255,.35); background: rgba(124,92,255,.12)">‚ú®</div>
          </div>

          <div style="margin-top:12px; display:grid; gap:10px">
            <div style="padding:12px; border-radius:16px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.03)">
              <div style="font-weight:800">–§–æ–∫—É—Å: –•—É–¥–∂–∞–Ω–¥</div>
              <div style="color:var(--muted2); margin-top:4px; font-size:13px">–ï–¥–∞ ‚Ä¢ –°–∞–ª–æ–Ω—ã ‚Ä¢ –ê–ø—Ç–µ–∫–∏ ‚Ä¢ –ê–≤—Ç–æ ‚Ä¢ –£—Å–ª—É–≥–∏</div>
            </div>

            <div style="padding:12px; border-radius:16px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.03)">
              <div style="font-weight:800">–ë–∏–∑–Ω–µ—Å–∞–º</div>
              <div style="color:var(--muted2); margin-top:4px; font-size:13px">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ, –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è, –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
      <div class="sub">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ‚Äî –∏ —Å—Ä–∞–∑—É —É–≤–∏–¥–∏—Ç–µ –º–µ—Å—Ç–∞.</div>
      <div class="cats" id="cats"></div>
    </section>

    <section class="section">
      <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
      <div class="sub">–§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫—É/–∫–∞—Ç–µ–≥–æ—Ä–∏–∏. –ú–æ–∂–Ω–æ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É –∏–ª–∏ ‚Äú—Ä—è–¥–æ–º‚Äù.</div>
      <div class="grid" id="results"></div>
      <div id="empty" class="empty" style="display:none; margin-top:12px;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é.</div>
    </section>

    <section class="section">
      <h2>–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ –≤ –•—É–¥–∂–∞–Ω–¥–µ</h2>
      <div class="sub">–ü–æ–¥–±–æ—Ä–∫–∞ –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É (demo-–ª–æ–≥–∏–∫–∞).</div>
      <div class="grid" id="popular"></div>
    </section>

    <section class="section">
      <h2>–†—è–¥–æ–º —Å–æ –º–Ω–æ–π</h2>
      <div class="sub">–¢—Ä–µ–±—É–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∂–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É.</div>
      <div class="grid" id="near"></div>
      <div id="nearHint" class="empty" style="display:none; margin-top:12px;">
        –ù–∞–∂–º–∏—Ç–µ ‚Äúüìç –†—è–¥–æ–º —Å–æ –º–Ω–æ–π‚Äù, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –±–ª–∏–∂–∞–π—à–∏–µ –º–µ—Å—Ç–∞.
      </div>
    </section>

    <footer>
      <div class="mini"><span class="dot"></span> Demo ‚Ä¢ KoftaGard ‚Ä¢ Khujand</div>
      <div class="mini">–î–∞–Ω–Ω—ã–µ: categories.json / places.json</div>
    </footer>
  </div>

  <script>
    // –ü–æ–º–µ–Ω—è–π—Ç–µ –Ω–∞ URL –µ—Å–ª–∏ JSON –ª–µ–∂–∏—Ç –Ω–µ —Ä—è–¥–æ–º
    const CATEGORIES_URL = "./categories.json";
    const PLACES_URL = "./places.json";

    const state = {
      categories: [],
      places: [],
      selectedCategory: "",
      query: "",
      sort: "popular",
      userPos: null
    };

    const $ = (id) => document.getElementById(id);

    const icons = {
      food: "üçΩÔ∏è",
      beauty: "üíá‚Äç‚ôÄÔ∏è",
      auto: "üöó",
      pharmacy: "üíä",
      repair: "üõ†Ô∏è",
      shops: "üè™",
      services: "üèõÔ∏è"
    };

    function safeText(s){
      return String(s ?? "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function kmFromTo(lat1, lon1, lat2, lon2){
      const R = 6371;
      const toRad = (d) => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
                Math.sin(dLon/2)**2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    function getCategoryTitle(catId){
      const c = state.categories.find(x => x.id === catId);
      return c ? c.title : catId;
    }

    function placeHasQuery(p, q){
      if(!q) return true;
      const hay = (p.name + " " + (p.address||"") + " " + (p.tags||[]).join(" ")).toLowerCase();
      return hay.includes(q.toLowerCase());
    }

    function normalizePlace(p){
      return {
        id: String(p.id ?? crypto.randomUUID()),
        name: p.name || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",
        category: p.category || "",
        city: p.city || "Khujand",
        address: p.address || "",
        geo: {
          lat: Number(p.geo?.lat ?? p.lat ?? NaN),
          lng: Number(p.geo?.lng ?? p.lng ?? NaN)
        },
        cover: p.cover || "",
        images: Array.isArray(p.images) ? p.images : [],
        contacts: {
          phone: p.contacts?.phone || p.phone || "",
          whatsapp: p.contacts?.whatsapp || "",
          website: p.contacts?.website || ""
        },
        hours: p.hours || {},
        tags: Array.isArray(p.tags) ? p.tags : [],
        rating: Number.isFinite(+p.rating) ? +p.rating : null,
        price_level: Number.isFinite(+p.price_level) ? +p.price_level : null,
        verified: !!p.verified,
        source: p.source || "manual",
        updated_at: p.updated_at || ""
      };
    }

    function renderCategories(){
      const catsEl = $("cats");
      catsEl.innerHTML = "";

      // counts
      const counts = state.places.reduce((acc,p)=>{
        acc[p.category] = (acc[p.category]||0) + 1;
        return acc;
      }, {});

      for(const c of state.categories){
        const isActive = state.selectedCategory === c.id;
        const el = document.createElement("button");
        el.type = "button";
        el.className = "cat" + (isActive ? " active" : "");
        el.innerHTML = `
          <div class="left">
            <div class="badge">${safeText(icons[c.id] || "üìç")}</div>
            <div>
              <div class="title">${safeText(c.title)}</div>
              <div class="count">${(counts[c.id]||0)} –º–µ—Å—Ç</div>
            </div>
          </div>
          <div style="color:var(--muted2); font-weight:900">‚Ä∫</div>
        `;
        el.addEventListener("click", ()=>{
          state.selectedCategory = (state.selectedCategory === c.id) ? "" : c.id;
          syncControls();
          renderAll();
        });
        catsEl.appendChild(el);
      }
    }

    function cardHTML(p){
      const catTitle = getCategoryTitle(p.category);
      const phone = p.contacts.phone;
      const hasGeo = Number.isFinite(p.geo.lat) && Number.isFinite(p.geo.lng);
      const dist = (state.userPos && hasGeo)
        ? kmFromTo(state.userPos.lat, state.userPos.lng, p.geo.lat, p.geo.lng)
        : null;

      const pill = dist != null ? `${catTitle} ‚Ä¢ ${dist.toFixed(1)} –∫–º` : catTitle;
      const rating = (p.rating != null) ? `‚≠ê ${p.rating.toFixed(1)}` : "‚Äî";
      const price = (p.price_level != null) ? "‚Ç∏".repeat(Math.max(1, Math.min(4, p.price_level))) : "";

      const img = p.cover
        ? `<img src="${safeText(p.cover)}" alt="${safeText(p.name)}" loading="lazy">`
        : `<div style="width:100%;height:100%;display:grid;place-items:center;color:var(--muted2)">–ù–µ—Ç —Ñ–æ—Ç–æ</div>`;

      const mapsLink = hasGeo ? `https://www.google.com/maps?q=${p.geo.lat},${p.geo.lng}` : "";

      return `
        <article class="card">
          <div class="thumb">
            ${img}
            <div class="pill">${safeText(pill)}</div>
          </div>
          <div class="content">
            <h3 class="name">${safeText(p.name)}</h3>
            <p class="meta">${safeText(p.address || "–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω")}</p>
            <div class="row">
              <div class="stars">${rating}</div>
              <div class="kpi">${price}</div>
            </div>
            <div class="btns">
              ${phone ? `<a href="tel:${safeText(phone)}">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</a>` : ""}
              ${mapsLink ? `<a target="_blank" rel="noopener" href="${safeText(mapsLink)}">üß≠ –ú–∞—Ä—à—Ä—É—Ç</a>` : ""}
              ${p.contacts.website ? `<a target="_blank" rel="noopener" href="${safeText(p.contacts.website)}">üåê –°–∞–π—Ç</a>` : ""}
            </div>
          </div>
        </article>
      `;
    }

    function applyFilters(){
      const q = state.query.trim();
      const cat = state.selectedCategory;

      let list = state.places.filter(p => {
        const okCat = !cat || p.category === cat;
        const okQ = placeHasQuery(p, q);
        const okCity = (p.city || "").toLowerCase() === "khujand"; // —Ñ–æ–∫—É—Å –≥–æ—Ä–æ–¥–∞
        return okCat && okQ && okCity;
      });

      // sort
      if(state.sort === "rating"){
        list.sort((a,b)=> (b.rating||0) - (a.rating||0));
      } else if(state.sort === "near"){
        list.sort((a,b)=>{
          if(!state.userPos) return 0;
          const da = (Number.isFinite(a.geo.lat) && Number.isFinite(a.geo.lng))
            ? kmFromTo(state.userPos.lat, state.userPos.lng, a.geo.lat, a.geo.lng) : 1e9;
          const db = (Number.isFinite(b.geo.lat) && Number.isFinite(b.geo.lng))
            ? kmFromTo(state.userPos.lat, state.userPos.lng, b.geo.lat, b.geo.lng) : 1e9;
          return da - db;
        });
      } else {
        // popular (demo): rating desc then id
        list.sort((a,b)=> (b.rating||0) - (a.rating||0));
      }

      return list;
    }

    function renderResults(){
      const results = applyFilters();
      $("status").textContent = `–ù–∞–π–¥–µ–Ω–æ: ${results.length}`;
      $("results").innerHTML = results.slice(0, 9).map(cardHTML).join("");
      $("empty").style.display = results.length ? "none" : "block";
    }

    function renderPopular(){
      const list = [...state.places]
        .filter(p => (p.city||"").toLowerCase() === "khujand")
        .sort((a,b)=> (b.rating||0) - (a.rating||0))
        .slice(0, 6);

      $("popular").innerHTML = list.map(cardHTML).join("") || `<div class="empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>`;
    }

    function renderNear(){
      const nearHint = $("nearHint");
      if(!state.userPos){
        $("near").innerHTML = "";
        nearHint.style.display = "block";
        return;
      }
      nearHint.style.display = "none";

      const list = state.places
        .filter(p => (p.city||"").toLowerCase() === "khujand")
        .filter(p => Number.isFinite(p.geo.lat) && Number.isFinite(p.geo.lng))
        .map(p => ({
          p,
          d: kmFromTo(state.userPos.lat, state.userPos.lng, p.geo.lat, p.geo.lng)
        }))
        .sort((a,b)=> a.d - b.d)
        .slice(0, 6)
        .map(x => x.p);

      $("near").innerHTML = list.map(cardHTML).join("") || `<div class="empty">–ü–æ–∫–∞ –Ω–µ—Ç –º–µ—Å—Ç —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏.</div>`;
    }

    function renderAll(){
      renderCategories();
      renderResults();
      renderPopular();
      renderNear();
    }

    function syncControls(){
      $("catSelect").value = state.selectedCategory;
      $("sort").value = state.sort;
      // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π ‚Äî —á–µ—Ä–µ–∑ renderCategories()
    }

    async function loadJSON(url){
      const r = await fetch(url, { cache: "no-store" });
      if(!r.ok) throw new Error(`${url} -> ${r.status}`);
      return r.json();
    }

    async function init(){
      try{
        const [cats, places] = await Promise.all([
          loadJSON(CATEGORIES_URL),
          loadJSON(PLACES_URL)
        ]);

        state.categories = Array.isArray(cats) ? cats : [];
        state.places = (Array.isArray(places) ? places : []).map(normalizePlace);

        // fill select
        const sel = $("catSelect");
        sel.innerHTML = `<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>` + state.categories
          .map(c => `<option value="${safeText(c.id)}">${safeText(c.title)}</option>`)
          .join("");

        $("status").textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ –º–µ—Å—Ç: ${state.places.length}`;
        renderAll();
      } catch(err){
        console.error(err);
        $("status").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSON. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç–∏ –∏ CORS.";
      }
    }

    // Events
    $("q").addEventListener("input", (e)=>{
      state.query = e.target.value;
      renderResults();
    });

    $("catSelect").addEventListener("change", (e)=>{
      state.selectedCategory = e.target.value;
      renderAll();
    });

    $("sort").addEventListener("change", (e)=>{
      state.sort = e.target.value;
      renderResults();
      renderNear();
    });

    $("btnAdd").addEventListener("click", (e)=>{
      e.preventDefault();
      alert("Demo: —Ç—É—Ç –±—É–¥–µ—Ç —Ñ–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Å—Ç–∞ (–∑–∞—è–≤–∫–∞ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é).");
    });

    $("btnLocate").addEventListener("click", ()=>{
      if(!navigator.geolocation){
        $("geoStatus").textContent = "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è: –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è";
        return;
      }
      $("geoStatus").textContent = "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è: –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø‚Ä¶";
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          state.userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          $("geoStatus").textContent = `–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è: ${state.userPos.lat.toFixed(5)}, ${state.userPos.lng.toFixed(5)}`;
          renderNear();
          if(state.sort === "near") renderResults();
        },
        ()=>{
          $("geoStatus").textContent = "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è: –¥–æ—Å—Ç—É–ø –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω";
        },
        { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 }
      );
    });

    init();
  </script>
</body>
</html>
