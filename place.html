<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KoftaGard ‚Äî –ú–µ—Å—Ç–æ</title>
  
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É Leaflet –¥–ª—è OpenStreetMap -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
   integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
   crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
   integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
   crossorigin=""></script>

  <style>
    :root{
      --bg: #f3fbf6;
      --card: #ffffff;
      --border: rgba(16, 24, 40, .10);
      --text: #0f172a;
      --muted: rgba(15, 23, 42, .70);
      --muted2: rgba(15, 23, 42, .55);
      --accent: #4CAF50;
      --accent2:#3f9f44;
      --shadow: 0 18px 50px rgba(2, 44, 18, .10);
      --radius: 18px;
    }
    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(76,175,80,.18), transparent 60%),
        radial-gradient(900px 500px at 80% 0%, rgba(76,175,80,.10), transparent 60%),
        var(--bg);
      color: var(--text);
      min-height:100vh;
    }
    a{ color: inherit; text-decoration:none; }
    .wrap{ max-width: 980px; margin:0 auto; padding: 20px 16px 48px; }

    /* top bar */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding: 8px 0 18px;
    }
    .brand{ display:flex; align-items:center; gap:12px; font-weight: 800; }
    .logo{
      width: 42px; height: 42px; border-radius: 14px;
      border: 1px solid rgba(15, 23, 42, .12);
      background: #fff;
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(76,175,80,.14);
      display:grid; place-items:center;
      flex: 0 0 auto;
    }
    .logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .brand small{ display:block; color: var(--muted2); font-weight: 650; margin-top:2px; }

    .btn{
      display:inline-flex; align-items:center; gap:8px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.86);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 750;
      transition: transform .08s ease, box-shadow .15s ease, border-color .15s ease;
      user-select:none;
      cursor:pointer;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(2,44,18,.08);
      border-color: rgba(76,175,80,.35);
    }
    .btn.primary{
      background: rgba(76,175,80,.12);
      border-color: rgba(76,175,80,.45);
    }

    /* layout */
    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid rgba(15, 23, 42, .12);
      background: #fff;
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .content{ padding: 14px; }

    .title{
      margin: 0 0 6px;
      font-weight: 900;
      letter-spacing: -.2px;
      font-size: clamp(20px, 2.5vw, 30px);
      line-height: 1.15;
    }
    .meta{
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
      margin: 0 0 12px;
    }
    .pillrow{
      display:flex; flex-wrap:wrap; gap:8px;
      margin: 10px 0 12px;
    }
    .pill{
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12.5px;
      font-weight: 800;
      border: 1px solid rgba(15, 23, 42, .12);
      background: rgba(243,251,246,.9);
    }
    .pill.green{
      border-color: rgba(76,175,80,.35);
      background: rgba(76,175,80,.10);
    }

    .actions{
      display:flex; flex-wrap:wrap; gap:8px;
      margin-top: 10px;
    }
    .action{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15, 23, 42, .12);
      background: rgba(243,251,246,.85);
      font-weight: 850;
      font-size: 13.5px;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .action:hover{
      border-color: rgba(76,175,80,.40);
      background: rgba(76,175,80,.10);
    }

    /* –ì–ê–õ–ï–†–ï–Ø-–°–õ–ê–ô–î–ï–† */
    .gallery-container {
      position: relative;
      width: 100%;
      overflow: hidden;
      border-radius: 16px;
      background: rgba(15, 23, 42, .04);
      border: 1px solid rgba(15, 23, 42, .10);
    }
    .slider-wrapper {
      display: flex;
      transition: transform 0.3s ease;
      height: 300px;
    }
    .slide {
      min-width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .slider-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(15, 23, 42, .12);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      font-weight: bold;
      font-size: 18px;
      transition: all 0.2s;
    }
    .slider-btn:hover {
      background: white;
      border-color: rgba(76,175,80,.40);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .slider-btn.prev {
      left: 10px;
    }
    .slider-btn.next {
      right: 10px;
    }
    .slider-dots {
      position: absolute;
      bottom: 15px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 8px;
      z-index: 10;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(15, 23, 42, .20);
      cursor: pointer;
      transition: all 0.2s;
    }
    .dot.active {
      background: var(--accent);
      border-color: var(--accent2);
      transform: scale(1.2);
    }

    /* –°–µ–∫—Ü–∏—è –∫–∞—Ä—Ç—ã */
    .map-section {
      margin-top: 20px;
    }
    .map-container {
      height: 300px;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(15, 23, 42, .12);
      margin-top: 10px;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    .route-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .route-option {
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid rgba(15, 23, 42, .12);
      background: rgba(243,251,246,.85);
      font-weight: 650;
      cursor: pointer;
      transition: all 0.2s;
    }
    .route-option:hover {
      border-color: rgba(76,175,80,.40);
      background: rgba(76,175,80,.10);
    }
    .route-option.active {
      background: rgba(76,175,80,.12);
      border-color: rgba(76,175,80,.45);
    }

    /* side card */
    .side h3{
      margin: 0 0 10px;
      font-size: 15px;
      font-weight: 900;
    }
    .kv{
      display:grid;
      gap:8px;
      color: var(--muted);
      font-size: 13.5px;
      line-height: 1.45;
    }
    .kv b{ color: var(--text); }
    .tags{
      display:flex; flex-wrap:wrap; gap:8px; margin-top: 10px;
    }
    .tag{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, .12);
      background: rgba(255,255,255,.9);
      font-weight: 800;
      font-size: 12px;
      color: rgba(15, 23, 42, .72);
    }

    .empty{
      border: 1px dashed rgba(15, 23, 42, .18);
      border-radius: var(--radius);
      padding: 16px;
      color: var(--muted);
      background: rgba(255,255,255,.75);
    }

    /* modal –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ */
    .modal{
      position:fixed; inset:0;
      background: rgba(2, 6, 23, .55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal.open{ display:flex; }
    .modalbox{
      max-width: 980px;
      width: 100%;
      border-radius: 18px;
      overflow:hidden;
      background:#fff;
      border: 1px solid rgba(15, 23, 42, .12);
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
    }
    .modalimg{
      width:100%;
      max-height: 75vh;
      object-fit: contain;
      display:block;
      background: #fff;
    }
    .modalbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-top: 1px solid rgba(15, 23, 42, .10);
      color: var(--muted);
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" title="KoftaGard">
          <img
            src="https://play-lh.googleusercontent.com/hz0iJ1uOy2Qla1j20KA0fOg5yMwvuD2atqnD2OYVsHeYPmoL99J399NdZGlFgmhXcpKvlVrQd_CMQd5Yo13N=w240-h480-rw"
            alt="KoftaGard Logo"
            loading="lazy"
          />
        </div>
        <div>
          KoftaGard
          <small>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –•—É–¥–∂–∞–Ω–¥–∞</small>
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <a class="btn" href="./demo.html">‚Üê –ù–∞–∑–∞–¥</a>
        <button class="btn primary" id="btnCopyLink" type="button">üîó –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
      </div>
    </div>

    <div id="page"></div>
  </div>

  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-label="–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
    <div class="modalbox">
      <img id="modalImg" class="modalimg" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" />
      <div class="modalbar">
        <span id="modalCaption">–§–æ—Ç–æ</span>
        <button class="btn" id="modalClose" type="button">–ó–∞–∫—Ä—ã—Ç—å ‚úï</button>
      </div>
    </div>
  </div>

  <script>
    const CATEGORIES_URL = "./categories.json";
    const PLACES_URL = "./places.json";

    const $ = (id) => document.getElementById(id);

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function getParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    function normalizePlace(p){
      return {
        id: String(p.id ?? crypto.randomUUID()),
        name: p.name || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",
        category: p.category || "",
        city: p.city || "Khujand",
        address: p.address || "",
        geo: {
          lat: Number(p.geo?.lat ?? p.lat ?? NaN),
          lng: Number(p.geo?.lng ?? p.lng ?? NaN)
        },
        cover: p.cover || "",
        images: Array.isArray(p.images) ? p.images : [],
        contacts: {
          phone: p.contacts?.phone || p.phone || "",
          whatsapp: p.contacts?.whatsapp || "",
          website: p.contacts?.website || p.website || ""
        },
        hours: p.hours || {},
        tags: Array.isArray(p.tags) ? p.tags : [],
        rating: Number.isFinite(+p.rating) ? +p.rating : null,
        price_level: Number.isFinite(+p.price_level) ? +p.price_level : null,
        verified: !!p.verified,
        source: p.source || "manual",
        updated_at: p.updated_at || ""
      };
    }

    async function loadJSON(url){
      const r = await fetch(url, { cache: "no-store" });
      if(!r.ok) throw new Error(`${url} -> ${r.status}`);
      return r.json();
    }

    function categoryTitle(categories, id){
      return categories.find(c => c.id === id)?.title || id;
    }

    function formatHours(hours){
      if(!hours || typeof hours !== "object") return "‚Äî";
      const map = [
        ["mon","–ü–Ω"],["tue","–í—Ç"],["wed","–°—Ä"],["thu","–ß—Ç"],["fri","–ü—Ç"],["sat","–°–±"],["sun","–í—Å"]
      ];
      const lines = map.map(([k, label])=>{
        const v = hours[k];
        if(!v) return null;
        return `${label}: ${v === "closed" ? "–≤—ã—Ö–æ–¥–Ω–æ–π" : v}`;
      }).filter(Boolean);
      return lines.length ? lines.join(" ‚Ä¢ ") : "‚Äî";
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥–∞–ª–µ—Ä–µ–∏-—Å–ª–∞–π–¥–µ—Ä–∞
    function buildGallerySlider(p) {
      const imgs = [];
      if(p.cover) imgs.push(p.cover);
      for(const im of (p.images || [])) if(im && !imgs.includes(im)) imgs.push(im);

      if (imgs.length === 0) {
        return `<div class="gallery-container" style="height: 200px; display: flex; align-items: center; justify-content: center; color: rgba(15,23,42,.55);">
                  –ù–µ—Ç —Ñ–æ—Ç–æ
                </div>`;
      }

      let slidesHTML = '';
      imgs.forEach((img, index) => {
        slidesHTML += `
          <div class="slide">
            <img src="${esc(img)}" alt="${esc(p.name)} - —Ñ–æ—Ç–æ ${index + 1}" loading="lazy">
          </div>
        `;
      });

      let dotsHTML = '';
      imgs.forEach((_, index) => {
        dotsHTML += `<div class="dot ${index === 0 ? 'active' : ''}" data-index="${index}"></div>`;
      });

      return `
        <div class="gallery-container">
          <div class="slider-wrapper" id="sliderWrapper">
            ${slidesHTML}
          </div>
          ${imgs.length > 1 ? `
            <button class="slider-btn prev">‚Äπ</button>
            <button class="slider-btn next">‚Ä∫</button>
            <div class="slider-dots">
              ${dotsHTML}
            </div>
          ` : ''}
        </div>
      `;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã OpenStreetMap
    function initMap(p) {
      const mapHTML = `
        <div class="map-section">
          <h3 style="margin:0 0 8px;">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</h3>
          <div class="map-container">
            <div id="map"></div>
          </div>
          <div class="route-controls">
            <div class="route-option active" data-route-type="current">–û—Ç –º–æ–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è</div>
            <div class="route-option" data-route-type="select">–í—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ</div>
            <button class="btn primary" id="buildRouteBtn" style="margin-left: auto;">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
            <button class="btn" id="clearRouteBtn">–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
          </div>
          <div id="routeInstructions" style="margin-top: 10px; font-size: 13px; color: var(--muted2);"></div>
        </div>
      `;

      // –í—Å—Ç–∞–≤–ª—è–µ–º HTML –∫–∞—Ä—Ç—ã
      document.querySelector('.side .content').insertAdjacentHTML('beforeend', mapHTML);

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ DOM
      setTimeout(() => {
        const hasValidCoords = Number.isFinite(p.geo.lat) && Number.isFinite(p.geo.lng);
        
        if (!hasValidCoords) {
          document.getElementById('map').innerHTML = 
            '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted);">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã</div>';
          return;
        }

        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
        const map = L.map('map').setView([p.geo.lat, p.geo.lng], 15);
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–∞
        const placeMarker = L.marker([p.geo.lat, p.geo.lng]).addTo(map)
          .bindPopup(`<b>${esc(p.name)}</b><br>${esc(p.address || '')}`)
          .openPopup();

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–º
        let routePolyline = null;
        let selectedPoint = null;
        let selectedPointMarker = null;
        let userLocation = null;
        let selectPointMode = false;
        let mapClickListener = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
        function buildRoute() {
          const routeType = document.querySelector('.route-option.active').dataset.routeType;
          const startPoint = routeType === 'current' ? userLocation : selectedPoint;
          const endPoint = [p.geo.lat, p.geo.lng];
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω–∞ –ª–∏ –Ω–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞
          if (!startPoint) {
            if (routeType === 'current') {
              document.getElementById('routeInstructions').innerHTML = 
                '<span style="color: #ff6b6b;">–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ.</span>';
            } else {
              document.getElementById('routeInstructions').innerHTML = 
                '<span style="color: #ff6b6b;">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ.</span>';
            }
            return;
          }
          
          // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Ä—à—Ä—É—Ç
          if (routePolyline) {
            map.removeLayer(routePolyline);
            routePolyline = null;
          }
          
          document.getElementById('routeInstructions').innerHTML = 
            '<span style="color: #4CAF50;">–°—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç...</span>';
          
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º OSRM API –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
          const url = `https://router.project-osrm.org/route/v1/driving/${startPoint[1]},${startPoint[0]};${endPoint[1]},${endPoint[0]}?overview=full&geometries=geojson&steps=true`;
          
          fetch(url)
            .then(response => response.json())
            .then(data => {
              if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–∞—Ä—à—Ä—É—Ç –Ω–∞ –∫–∞—Ä—Ç–µ –∑–µ–ª–µ–Ω—ã–º —Ü–≤–µ—Ç–æ–º
                routePolyline = L.geoJSON(route.geometry, {
                  style: {
                    color: '#4CAF50',
                    weight: 5,
                    opacity: 0.7
                  }
                }).addTo(map);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞—á–∞–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∞
                L.marker(startPoint, {
                  icon: L.divIcon({
                    className: 'start-marker',
                    html: '<div style="background: #4CAF50; width: 14px; height: 14px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                  })
                }).addTo(map).bindPopup('–ù–∞—á–∞–ª–æ –º–∞—Ä—à—Ä—É—Ç–∞');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Ä—à—Ä—É—Ç–µ
                document.getElementById('routeInstructions').innerHTML = `
                  <div style="background: rgba(76,175,80,0.1); padding: 10px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                    <div><b>–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω!</b></div>
                    <div>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${(route.distance / 1000).toFixed(1)} –∫–º</div>
                    <div>–í—Ä–µ–º—è –≤ –ø—É—Ç–∏: ${Math.round(route.duration / 60)} –º–∏–Ω</div>
                    <div style="font-size: 12px; margin-top: 5px; color: var(--muted2);">
                      ${routeType === 'current' ? '–û—Ç –≤–∞—à–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è' : '–û—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏'}
                    </div>
                  </div>
                `;
                
                // –§–∏—Ç –∫–∞—Ä—Ç—ã –ø–æ–¥ –º–∞—Ä—à—Ä—É—Ç
                map.fitBounds(routePolyline.getBounds(), { padding: [50, 50] });
              } else {
                document.getElementById('routeInstructions').innerHTML = 
                  '<span style="color: #ff6b6b;">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —Ç–æ—á–∫—É.</span>';
              }
            })
            .catch(error => {
              console.error('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞:', error);
              document.getElementById('routeInstructions').innerHTML = 
                '<span style="color: #ff6b6b;">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.</span>';
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
        function setupPointSelection() {
          selectPointMode = true;
          document.getElementById('routeInstructions').innerHTML = 
            '<span style="color: #4CAF50;">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É –Ω–∞—á–∞–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∞.</span>';
          
          // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –±—ã–ª
          if (mapClickListener) {
            map.off('click', mapClickListener);
          }
          
          // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
          mapClickListener = function(e) {
            selectedPoint = [e.latlng.lat, e.latlng.lng];
            
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Ä–∫–µ—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏
            if (selectedPointMarker) {
              map.removeLayer(selectedPointMarker);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏
            selectedPointMarker = L.marker(e.latlng, {
              icon: L.divIcon({
                className: 'selected-point-marker',
                html: '<div style="background: #2196F3; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>',
                iconSize: [16, 16],
                iconAnchor: [8, 8]
              })
            }).addTo(map).bindPopup('–¢–æ—á–∫–∞ –Ω–∞—á–∞–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∞<br>–ù–∞–∂–º–∏—Ç–µ "–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç"').openPopup();
            
            document.getElementById('routeInstructions').innerHTML = 
              `<span style="color: #2196F3;">–í—ã–±—Ä–∞–Ω–∞ —Ç–æ—á–∫–∞: ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}<br>–ù–∞–∂–º–∏—Ç–µ "–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç"</span>`;
          };
          
          map.on('click', mapClickListener);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
        function setupCurrentLocation() {
          selectPointMode = false;
          
          // –£–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
          if (mapClickListener) {
            map.off('click', mapClickListener);
            mapClickListener = null;
          }
          
          // –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏
          if (selectedPointMarker) {
            map.removeLayer(selectedPointMarker);
            selectedPointMarker = null;
          }
          
          if (!userLocation) {
            document.getElementById('routeInstructions').innerHTML = 
              '<span style="color: #4CAF50;">–û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ... –ù–∞–∂–º–∏—Ç–µ "–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç".</span>';
            
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(
                (position) => {
                  userLocation = [position.coords.latitude, position.coords.longitude];
                  document.getElementById('routeInstructions').innerHTML = 
                    `<span style="color: #4CAF50;">–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ.<br>–ù–∞–∂–º–∏—Ç–µ "–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç"</span>`;
                },
                () => {
                  document.getElementById('routeInstructions').innerHTML = 
                    '<span style="color: #ff6b6b;">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.</span>';
                }
              );
            } else {
              document.getElementById('routeInstructions').innerHTML = 
                '<span style="color: #ff6b6b;">–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é.</span>';
            }
          } else {
            document.getElementById('routeInstructions').innerHTML = 
              '<span style="color: #4CAF50;">–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.<br>–ù–∞–∂–º–∏—Ç–µ "–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç"</span>';
          }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        document.getElementById('buildRouteBtn').addEventListener('click', buildRoute);
        
        document.getElementById('clearRouteBtn').addEventListener('click', () => {
          // –û—á–∏—â–∞–µ–º –º–∞—Ä—à—Ä—É—Ç
          if (routePolyline) {
            map.removeLayer(routePolyline);
            routePolyline = null;
          }
          
          // –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞—á–∞–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∞ (–Ω–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏)
          map.eachLayer((layer) => {
            if (layer._icon && layer._icon.classList && 
                layer._icon.classList.contains('start-marker')) {
              map.removeLayer(layer);
            }
          });
          
          document.getElementById('routeInstructions').innerHTML = '';
          
          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞—Ä—Ç—É –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –≤–∏–¥—É
          map.setView([p.geo.lat, p.geo.lng], 15);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ–ø—Ü–∏–π –º–∞—Ä—à—Ä—É—Ç–∞
        document.querySelectorAll('.route-option').forEach(option => {
          option.addEventListener('click', function() {
            document.querySelectorAll('.route-option').forEach(opt => 
              opt.classList.remove('active'));
            this.classList.add('active');
            
            if (this.dataset.routeType === 'select') {
              setupPointSelection();
            } else {
              setupCurrentLocation();
            }
          });
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (—Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ)
        setupCurrentLocation();

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
        window.currentMap = map;
      }, 100);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–ª–∞–π–¥–µ—Ä–∞ –≥–∞–ª–µ—Ä–µ–∏
    function initGallerySlider() {
      const sliderWrapper = document.getElementById('sliderWrapper');
      if (!sliderWrapper) return;

      const slides = document.querySelectorAll('.slide');
      const totalSlides = slides.length;
      let currentSlide = 0;

      function goToSlide(index) {
        if (index < 0) index = totalSlides - 1;
        if (index >= totalSlides) index = 0;
        
        currentSlide = index;
        sliderWrapper.style.transform = `translateX(-${currentSlide * 100}%)`;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ—á–∫–∏
        document.querySelectorAll('.dot').forEach((dot, i) => {
          dot.classList.toggle('active', i === currentSlide);
        });
      }

      // –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
      document.querySelector('.slider-btn.prev')?.addEventListener('click', () => {
        goToSlide(currentSlide - 1);
      });

      document.querySelector('.slider-btn.next')?.addEventListener('click', () => {
        goToSlide(currentSlide + 1);
      });

      // –¢–æ—á–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
      document.querySelectorAll('.dot').forEach(dot => {
        dot.addEventListener('click', () => {
          const index = parseInt(dot.dataset.index);
          goToSlide(index);
        });
      });

      // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      let autoSlideInterval = null;
      
      function startAutoSlide() {
        if (totalSlides > 1) {
          autoSlideInterval = setInterval(() => {
            goToSlide(currentSlide + 1);
          }, 5000);
        }
      }
      
      function stopAutoSlide() {
        if (autoSlideInterval) {
          clearInterval(autoSlideInterval);
          autoSlideInterval = null;
        }
      }
      
      startAutoSlide();
      
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫—É –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
      const galleryContainer = document.querySelector('.gallery-container');
      if (galleryContainer) {
        galleryContainer.addEventListener('mouseenter', stopAutoSlide);
        galleryContainer.addEventListener('mouseleave', startAutoSlide);
      }
    }

    function renderPlace(categories, p){
      const cat = categoryTitle(categories, p.category);
      const rating = (p.rating != null) ? `‚≠ê ${p.rating.toFixed(1)}` : "‚≠ê ‚Äî";
      const price = (p.price_level != null) ? "‚Ç∏".repeat(Math.max(1, Math.min(4, p.price_level))) : "";
      const hoursLine = formatHours(p.hours);

      const actions = [];
      if(p.contacts.phone) actions.push(`<a class="action" href="tel:${esc(p.contacts.phone)}">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</a>`);
      if(p.contacts.whatsapp) actions.push(`<a class="action" target="_blank" rel="noopener" href="https://wa.me/${esc(p.contacts.whatsapp.replace(/\D/g,''))}">üí¨ WhatsApp</a>`);
      if(p.contacts.website) actions.push(`<a class="action" target="_blank" rel="noopener" href="${esc(p.contacts.website)}">üåê –°–∞–π—Ç</a>`);

      const gallery = buildGallerySlider(p);

      const html = `
        <div class="grid">
          <div class="card">
            ${gallery}
            <div class="content">
              <h1 class="title">${esc(p.name)}</h1>
              <div class="meta">${esc(p.address || "–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω")}</div>

              <div class="pillrow">
                <span class="pill green">${esc(cat)}</span>
                <span class="pill">${rating} ${price ? " ‚Ä¢ " + price : ""}</span>
                <span class="pill">${esc(p.city)}</span>
                ${p.verified ? `<span class="pill green">‚úÖ Verified</span>` : ``}
              </div>

              <div class="actions">
                ${actions.join("") || `<span class="empty">–ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã.</span>`}
              </div>
            </div>
          </div>

          <div class="card side">
            <div class="content">
              <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
              <div class="kv">
                <div><b>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</b> ${esc(cat)}</div>
                <div><b>–ì–æ—Ä–æ–¥:</b> ${esc(p.city)}</div>
                <div><b>–ì—Ä–∞—Ñ–∏–∫:</b> ${esc(hoursLine)}</div>
                <div><b>–û–±–Ω–æ–≤–ª–µ–Ω–æ:</b> ${esc(p.updated_at || "‚Äî")}</div>
              </div>

              <div style="margin-top:12px">
                <h3 style="margin:0 0 8px">–¢–µ–≥–∏</h3>
                <div class="tags">
                  ${(p.tags && p.tags.length)
                    ? p.tags.slice(0, 12).map(t => `<span class="tag">${esc(t)}</span>`).join("")
                    : `<span class="tag">‚Äî</span>`
                  }
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      $("page").innerHTML = html;

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–∞–π–¥–µ—Ä –≥–∞–ª–µ—Ä–µ–∏
      initGallerySlider();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
      initMap(p);

      // Report
      const btnReport = document.getElementById('btnReport');
      if(btnReport){
        btnReport.addEventListener("click", ()=>{
          alert("–°–ø–∞—Å–∏–±–æ! –í –¥–µ–º–æ-–≤–µ—Ä—Å–∏–∏ —ç—Ç–æ —Ñ–æ—Ä–º–∞. –ü–æ–∑–∂–µ —Å–¥–µ–ª–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –∑–∞—è–≤–∫–∏ –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.");
        });
      }

      // Copy link
      $("btnCopyLink").addEventListener("click", async ()=>{
        try{
          await navigator.clipboard.writeText(window.location.href);
          $("btnCopyLink").textContent = "‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞";
          setTimeout(()=> $("btnCopyLink").textContent = "üîó –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É", 1400);
        }catch{
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é –∏–∑ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏.");
        }
      });
    }

    // Modal functions (–¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Ñ–æ—Ç–æ –ø—Ä–∏ –∫–ª–∏–∫–µ)
    function openModal(src, caption){
      $("modalImg").src = src;
      $("modalCaption").textContent = caption || "–§–æ—Ç–æ";
      $("modal").classList.add("open");
    }
    function closeModal(){
      $("modal").classList.remove("open");
      $("modalImg").src = "";
    }

    $("modalClose").addEventListener("click", closeModal);
    $("modal").addEventListener("click", (e)=>{ if(e.target.id === "modal") closeModal(); });
    window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeModal(); });

    async function init(){
      const id = getParam("id");
      if(!id){
        $("page").innerHTML = `<div class="empty">–ù–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ <b>id</b>. –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–∞–∫: <b>place.html?id=1</b></div>`;
        return;
      }

      try{
        const [cats, placesRaw] = await Promise.all([
          loadJSON(CATEGORIES_URL),
          loadJSON(PLACES_URL)
        ]);

        const categories = Array.isArray(cats) ? cats : [];
        const places = (Array.isArray(placesRaw) ? placesRaw : []).map(normalizePlace);

        const p = places.find(x => String(x.id) === String(id));
        if(!p){
          $("page").innerHTML = `<div class="empty">–ú–µ—Å—Ç–æ —Å id=<b>${esc(id)}</b> –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>`;
          return;
        }

        document.title = `KoftaGard ‚Äî ${p.name}`;
        renderPlace(categories, p);
      }catch(err){
        console.error(err);
        $("page").innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç–∏ –∫ JSON –∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–æ–≤.</div>`;
      }
    }

    init();
  </script>
</body>
</html>
